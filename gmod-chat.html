<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyProj Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            color: white;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid rgba(74, 85, 104, 0.5);
        }

        .tab {
            padding: 6px 12px;
            background: transparent;
            color: #6b7280;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 13px;
            font-weight: 500;
        }

        .tab:hover {
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            color: #e5e7eb;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab[data-tab="ic"].active {
            color: #ffffff;
        }

        .tab.hidden {
            display: none;
        }

        .tab.unread {
            position: relative;
        }

        .tab.unread::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            background: #ef4444;
            border-radius: 50%;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            background: rgba(0, 0, 0, 0.6);
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .messages::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.6);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 6px;
            line-height: 1.5;
            word-wrap: break-word;
            animation: fadeIn 0.15s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message .timestamp {
            opacity: 0;
            transition: opacity 0.15s ease;
            display: inline;
            color: #6b7280;
            font-size: 11px;
            margin-right: 6px;
        }

        .message:hover .timestamp {
            opacity: 1;
        }

        .timestamp-visible {
            opacity: 1 !important;
        }

        .speaker {
            color: #60a5fa;
            font-weight: 600;
        }

        .speaker-self {
            color: #fbbf24;
        }

        .text {
            color: #e5e7eb;
        }

        .action {
            color: #c4b5fd;
            font-style: italic;
        }

        .whisper .text {
            color: #9ca3af;
        }

        .whisper .speaker {
            color: #9ca3af;
        }

        .yell .text {
            color: #fca5a5;
        }

        .yell .speaker {
            color: #f87171;
        }

        .ooc {
            color: #86efac;
        }

        .ooc .speaker {
            color: #4ade80;
        }

        .looc {
            color: #6ee7b7;
            font-size: 12px;
        }

        .looc .speaker {
            color: #34d399;
        }

        .log-message {
            color: #9ca3af;
            font-style: italic;
        }

        .join {
            color: #10b981;
            font-weight: 600;
        }

        .leave {
            color: #ef4444;
            font-weight: 600;
        }

        .roll {
            color: #eab308;
            font-weight: 600;
        }

        .system-text {
            color: #9ca3af;
            font-size: 12px;
        }

        .broadcast {
            color: #f472b6;
            font-weight: 600;
            text-align: center;
            padding: 8px;
            background: rgba(244, 114, 182, 0.1);
            border-radius: 4px;
            margin: 4px 0;
        }

        .atmosphere {
            color: #a78bfa;
            font-style: italic;
            text-align: center;
            padding: 4px;
        }

        .input-container {
            position: relative;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.75);
            border-top: 1px solid rgba(74, 85, 104, 0.5);
        }

        .input-hint {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .input-area {
            width: 100%;
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(74, 85, 104, 0.5);
            border-radius: 4px;
            color: white;
            padding: 8px 70px 8px 10px;
            resize: none;
            font-family: inherit;
            font-size: 13px;
        }

        .input-area:focus {
            outline: none;
            border-color: rgba(96, 165, 250, 0.5);
        }

        .input-area::placeholder {
            color: #4b5563;
        }

        .char-counter {
            position: absolute;
            bottom: 16px;
            right: 20px;
            color: #4b5563;
            font-size: 11px;
            pointer-events: none;
        }

        .char-counter.warning {
            color: #f59e0b;
        }

        .char-counter.danger {
            color: #ef4444;
        }

        .read-only {
            text-align: center;
            color: #4b5563;
            font-style: italic;
            padding: 12px;
            background: rgba(0, 0, 0, 0.75);
            border-top: 1px solid rgba(74, 85, 104, 0.5);
            font-size: 12px;
        }

        .hidden {
            display: none !important;
        }

        /* Compact mode for overlay */
        .compact .tabs {
            padding: 4px 8px;
        }

        .compact .tab {
            padding: 4px 8px;
            font-size: 12px;
        }

        .compact .messages {
            padding: 8px;
        }

        .compact .message {
            margin-bottom: 4px;
            font-size: 13px;
        }

        .compact .input-container {
            padding: 6px 8px;
        }

        .compact .input-area {
            padding: 6px 60px 6px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chat-container">
        <div class="tabs" id="tabs">
            <button class="tab active" data-tab="ic" onclick="switchTab('ic')">IC</button>
            <button class="tab" data-tab="ooc" onclick="switchTab('ooc')">OOC</button>
            <button class="tab" data-tab="log" onclick="switchTab('log')">Log</button>
            <button class="tab" data-tab="system" onclick="switchTab('system')">System</button>
            <button class="tab hidden" data-tab="staff" onclick="switchTab('staff')">Staff</button>
        </div>

        <div class="messages" id="messages"></div>

        <div class="input-container" id="input-container">
            <div class="input-hint" id="input-hint">Press Enter to send â€¢ Shift+Enter for new line</div>
            <textarea 
                class="input-area" 
                id="message-input" 
                rows="1" 
                maxlength="300"
                placeholder="Say something..."
                oninput="updateCharCounter(); autoResize(this);"
                onkeydown="handleKeyPress(event)"
            ></textarea>
            <div class="char-counter" id="char-counter">0/300</div>
        </div>

        <div class="read-only hidden" id="read-only">Read-only â€¢ This tab shows history</div>
    </div>

    <script>
        let currentTab = 'ic';
        const maxLength = 300;
        const messages = [];
        let localPlayerName = 'You';
        let isStaff = false;
        let maxMessages = 100;

        // Channel mapping from Lua
        const CHANNEL = {
            SAY: 1,
            WHISPER: 2,
            YELL: 3,
            ME: 4,
            DO: 5,
            OOC: 6,
            LOOC: 7,
            BROADCAST: 8,
            ATMOSPHERE: 9,
            RADIO: 10,
        };

        function switchTab(tab) {
            currentTab = tab;
            
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                if (t.getAttribute('data-tab') === tab) {
                    t.classList.add('active');
                    t.classList.remove('unread');
                }
            });
            
            const input = document.getElementById('message-input');
            const hints = {
                'ic': 'Say something... (/w whisper, /y yell, /me action)',
                'ooc': 'Out-of-character message...',
                'staff': 'Staff communication...'
            };
            input.placeholder = hints[tab] || 'Type here...';
            
            const inputContainer = document.getElementById('input-container');
            const readOnly = document.getElementById('read-only');
            
            if (tab === 'log' || tab === 'system') {
                inputContainer.classList.add('hidden');
                readOnly.classList.remove('hidden');
            } else {
                inputContainer.classList.remove('hidden');
                readOnly.classList.add('hidden');
                input.focus();
            }
            
            renderMessages();
        }

        function getChannelTab(channel) {
            switch(channel) {
                case CHANNEL.SAY:
                case CHANNEL.WHISPER:
                case CHANNEL.YELL:
                case CHANNEL.ME:
                case CHANNEL.DO:
                case CHANNEL.RADIO:
                    return 'ic';
                case CHANNEL.OOC:
                case CHANNEL.LOOC:
                    return 'ooc';
                case CHANNEL.BROADCAST:
                case CHANNEL.ATMOSPHERE:
                    return 'ic'; // Special messages show in IC
                default:
                    return 'ic';
            }
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            const wasNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 60;
            
            let filtered;
            if (currentTab === 'log') {
                // Log shows all IC messages
                filtered = messages.filter(m => ['ic'].includes(getChannelTab(m.channel)) || m.channel === 'log');
            } else if (currentTab === 'system') {
                filtered = messages.filter(m => m.type === 'join' || m.type === 'leave' || m.type === 'roll' || m.type === 'system');
            } else if (currentTab === 'staff') {
                filtered = messages.filter(m => m.staffOnly);
            } else if (currentTab === 'ooc') {
                filtered = messages.filter(m => m.channel === CHANNEL.OOC || m.channel === CHANNEL.LOOC);
            } else {
                // IC tab
                filtered = messages.filter(m => {
                    const tab = getChannelTab(m.channel);
                    return tab === 'ic' && !m.staffOnly;
                });
            }
            
            container.innerHTML = '';
            
            filtered.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message';
                
                const timestamp = msg.timestamp ? `<span class="timestamp">[${msg.timestamp}]</span>` : '';
                const isSelf = msg.speaker === localPlayerName;
                const speakerClass = isSelf ? 'speaker speaker-self' : 'speaker';
                
                if (msg.type === 'broadcast') {
                    div.className = 'message broadcast';
                    div.innerHTML = `ðŸ“¢ ${msg.text}`;
                } else if (msg.type === 'atmosphere') {
                    div.className = 'message atmosphere';
                    div.innerHTML = `âœ¦ ${msg.text} âœ¦`;
                } else if (msg.type === 'join') {
                    div.innerHTML = `${timestamp}<span class="join">${msg.speaker}</span> <span class="system-text">connected</span>`;
                } else if (msg.type === 'leave') {
                    div.innerHTML = `${timestamp}<span class="leave">${msg.speaker}</span> <span class="system-text">disconnected</span>`;
                } else if (msg.type === 'roll') {
                    div.innerHTML = `${timestamp}<span class="roll">${msg.speaker}</span> <span class="system-text">${msg.text}</span>`;
                } else if (msg.type === 'system') {
                    div.innerHTML = `${timestamp}<span class="system-text">${msg.text}</span>`;
                } else if (msg.channel === CHANNEL.ME || msg.type === 'action') {
                    div.innerHTML = `${timestamp}<span class="action">* ${msg.speaker} ${msg.text}</span>`;
                } else if (msg.channel === CHANNEL.DO) {
                    div.innerHTML = `${timestamp}<span class="action">* ${msg.text}</span>`;
                } else if (msg.channel === CHANNEL.WHISPER) {
                    div.className = 'message whisper';
                    div.innerHTML = `${timestamp}<span class="${speakerClass}">${msg.speaker}</span> <span class="text">whispers: ${msg.text}</span>`;
                } else if (msg.channel === CHANNEL.YELL) {
                    div.className = 'message yell';
                    div.innerHTML = `${timestamp}<span class="${speakerClass}">${msg.speaker}</span> <span class="text">yells: ${msg.text}</span>`;
                } else if (msg.channel === CHANNEL.OOC) {
                    div.className = 'message ooc';
                    div.innerHTML = `${timestamp}(( <span class="${speakerClass}">${msg.speaker}</span>: <span class="text">${msg.text}</span> ))`;
                } else if (msg.channel === CHANNEL.LOOC) {
                    div.className = 'message looc';
                    div.innerHTML = `${timestamp}(( <span class="${speakerClass}">${msg.speaker}</span>: <span class="text">${msg.text}</span> ))`;
                } else if (currentTab === 'log') {
                    div.innerHTML = `<span class="timestamp timestamp-visible">[${msg.timestamp}]</span><span class="${speakerClass}">${msg.speaker}:</span> <span class="log-message">${msg.text}</span>`;
                } else {
                    // Normal say
                    div.innerHTML = `${timestamp}<span class="${speakerClass}">${msg.speaker}</span> <span class="text">says: ${msg.text}</span>`;
                }
                
                container.appendChild(div);
            });
            
            if (wasNearBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function updateCharCounter() {
            const input = document.getElementById('message-input');
            const counter = document.getElementById('char-counter');
            const len = input.value.length;
            counter.textContent = `${len}/${maxLength}`;
            
            counter.classList.remove('warning', 'danger');
            if (len >= maxLength - 20) {
                counter.classList.add('danger');
            } else if (len >= maxLength - 50) {
                counter.classList.add('warning');
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = document.getElementById('message-input');
                if (input.value.trim() === '') {
                    // Empty input - close chat
                    if (typeof gmod !== 'undefined' && gmod.closeChat) {
                        gmod.closeChat();
                    }
                } else {
                    sendMessage();
                }
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (text) {
                // Send to Lua
                if (typeof gmod !== 'undefined') {
                    gmod.sendMessage(currentTab, text);
                } else {
                    console.log(`[${currentTab}] ${text}`);
                }
                
                input.value = '';
                updateCharCounter();
                autoResize(input);
            }
        }

        // === API for Lua ===
        
        function addMessage(channel, type, speaker, text, timestamp, staffOnly) {
            messages.push({
                id: messages.length + 1,
                channel: channel,
                type: type,
                speaker: speaker,
                text: text,
                timestamp: timestamp || '',
                staffOnly: staffOnly || false
            });
            
            // Trim old messages
            while (messages.length > maxMessages) {
                messages.shift();
            }
            
            // Mark tab as unread if not current
            const targetTab = getChannelTab(channel);
            if (type === 'join' || type === 'leave' || type === 'system') {
                markUnread('system');
            } else if (staffOnly) {
                markUnread('staff');
            } else if (targetTab !== currentTab) {
                markUnread(targetTab);
            }
            
            renderMessages();
        }

        function markUnread(tab) {
            const tabBtn = document.querySelector(`.tab[data-tab="${tab}"]`);
            if (tabBtn && !tabBtn.classList.contains('active')) {
                tabBtn.classList.add('unread');
            }
        }

        function setLocalPlayer(name) {
            localPlayerName = name;
        }

        function setStaffMode(isStaffMode) {
            isStaff = isStaffMode;
            const staffTab = document.querySelector('.tab[data-tab="staff"]');
            if (staffTab) {
                if (isStaff) {
                    staffTab.classList.remove('hidden');
                } else {
                    staffTab.classList.add('hidden');
                    if (currentTab === 'staff') {
                        switchTab('ic');
                    }
                }
            }
        }

        function clearMessages() {
            messages.length = 0;
            renderMessages();
        }

        function setCompactMode(compact) {
            const container = document.getElementById('chat-container');
            if (compact) {
                container.classList.add('compact');
            } else {
                container.classList.remove('compact');
            }
        }

        function focusInput() {
            const input = document.getElementById('message-input');
            input.focus();
        }

        function setInputText(text) {
            const input = document.getElementById('message-input');
            input.value = text;
            updateCharCounter();
            autoResize(input);
            input.focus();
        }

        // Expose to Lua
        window.myproj = window.myproj || {};
        window.myproj.chat = {
            addMessage: addMessage,
            setLocalPlayer: setLocalPlayer,
            setStaffMode: setStaffMode,
            clearMessages: clearMessages,
            setCompactMode: setCompactMode,
            switchTab: switchTab,
            focusInput: focusInput,
            setInputText: setInputText,
            CHANNEL: CHANNEL
        };

        // Initialize
        renderMessages();
    </script>
</body>
</html>
