<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmod Roleplay Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            color: white;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #4a5568;
            border-radius: 4px;
            padding: 20px;
            margin: 20px;
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 8px;
        }

        .tab {
            padding: 8px 0;
            background: transparent;
            color: #6b7280;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 400;
        }

        .tab:hover {
            color: #9ca3af;
        }

        .tab.active {
            color: #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab[data-tab="ic"].active {
            color: #ffffff;
            border-bottom: 2px solid #ffffff;
        }

        .tab.hidden {
            display: none;
        }

        .messages {
            height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
            padding-right: 8px;
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .messages::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        /* Hide timestamps in IC by default, show on hover */
        .message .timestamp-ic {
            opacity: 0;
            transition: opacity 0.2s ease 0.15s;
            display: inline-block;
        }

        .message:hover .timestamp-ic {
            opacity: 1;
        }

        .timestamp {
            color: #6b7280;
            margin-right: 8px;
        }

        .speaker {
            color: #60a5fa;
            font-weight: 600;
        }

        .text {
            color: white;
            font-style: normal;
        }

        .action {
            color: #9ca3af;
            font-style: italic;
        }

        .log-message {
            color: #9ca3af;
        }

        .join {
            color: #10b981;
            font-weight: 600;
        }

        .leave {
            color: #ef4444;
            font-weight: 600;
        }

        .roll {
            color: #eab308;
            font-weight: 600;
        }

        .system-text {
            color: #9ca3af;
        }

        .separator {
            border-top: 1px solid #4a5568;
            margin-bottom: 16px;
        }

        .input-container {
            position: relative;
        }

        .input-area {
            width: 100%;
            background: transparent;
            border: 2px solid #4a5568;
            border-radius: 4px;
            color: white;
            padding: 12px 80px 12px 12px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }

        .input-area:focus {
            outline: none;
            border-color: #6b7280;
        }

        .input-area::placeholder {
            color: #6b7280;
        }

        .char-counter {
            position: absolute;
            bottom: 12px;
            right: 12px;
            color: #6b7280;
            font-size: 12px;
            transition: color 0.3s ease;
        }

        .char-counter.approaching-limit {
            color: #f59e0b;
        }

        .read-only {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 16px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="tabs">
            <button class="tab active" data-tab="ic" onclick="switchTab('ic')">IC</button>
            <button class="tab" data-tab="ooc" onclick="switchTab('ooc')">OOC</button>
            <button class="tab" data-tab="log" onclick="switchTab('log')">Log</button>
            <button class="tab" data-tab="system" onclick="switchTab('system')">System</button>
            <button class="tab" data-tab="staff" onclick="switchTab('staff')">Staff</button>
        </div>

        <div class="messages" id="messages"></div>

        <div class="separator"></div>

        <div class="input-container" id="input-container">
            <textarea 
                class="input-area" 
                id="message-input" 
                rows="2" 
                maxlength="500"
                placeholder="Type your message here..."
                oninput="updateCharCounter()"
                onkeydown="handleKeyPress(event)"
            ></textarea>
            <div class="char-counter" id="char-counter">0 / 500</div>
        </div>

        <div class="read-only hidden" id="read-only">Read-only view</div>
    </div>

    <script>
        let currentTab = 'ic';
        const maxLength = 500;

        const messages = [
            { id: 1, type: 'dialogue', channel: 'ic', speaker: 'James Porter', text: 'I saw someone moving near the abandoned warehouse earlier.', timestamp: '18:24:15' },
            { id: 2, type: 'dialogue', channel: 'ic', speaker: 'Rachel Vaughn', text: 'Really? Did you get a good look?', timestamp: '18:24:32' },
            { id: 3, type: 'action', channel: 'ic', text: '*Connor Hayes glances over, furrowing his brow.*', timestamp: '18:24:45' },
            { id: 4, type: 'dialogue', channel: 'ic', speaker: 'Connor Hayes', text: "Couldn't see much. They were wearing a hood, moving quickly.", timestamp: '18:24:58' },
            { id: 5, type: 'action', channel: 'ic', text: '*The sound of distant sirens can be heard in the background.*', timestamp: '18:25:12' },
            { id: 6, type: 'system', channel: 'ic', speaker: 'Dispatch', text: 'All units, be advised, suspicious activity reported near the docks.', timestamp: '18:25:30' },
            { id: 7, type: 'dialogue', channel: 'ic', speaker: 'Ethan Cross', text: 'We should check it out. Could be nothing big.', timestamp: '18:25:47' },
            { id: 8, type: 'dialogue', channel: 'ooc', speaker: 'PlayerOne', text: 'Hey, is the event still happening tonight?' },
            { id: 9, type: 'dialogue', channel: 'ooc', speaker: 'PlayerTwo', text: 'Yeah, should start around 8pm EST' },
            { id: 10, type: 'dialogue', channel: 'ooc', speaker: 'PlayerThree', text: 'Nice, I\'ll be there!' },
            { id: 11, type: 'dialogue', channel: 'log', speaker: 'Marcus Kane', text: 'I need everyone to gather at the town hall in five minutes.', timestamp: '17:45:23' },
            { id: 12, type: 'action', channel: 'log', text: '*Sarah Mitchell nods and starts walking toward the building.*', timestamp: '17:46:01' },
            { id: 13, type: 'dialogue', channel: 'log', speaker: 'David Chen', text: 'Got it, on my way.', timestamp: '17:46:15' },
            { id: 14, type: 'dialogue', channel: 'log', speaker: 'James Porter', text: 'I saw someone moving near the abandoned warehouse earlier.', timestamp: '18:24:15' },
            { id: 15, type: 'join', channel: 'system', speaker: 'PlayerOne', text: 'has connected to the server.', timestamp: '17:42:10' },
            { id: 16, type: 'join', channel: 'system', speaker: 'PlayerTwo', text: 'has connected to the server.', timestamp: '17:43:55' },
            { id: 17, type: 'system', channel: 'system', text: 'Server: Autosave completed successfully.', timestamp: '18:00:00' },
            { id: 18, type: 'roll', channel: 'system', speaker: 'Connor Hayes', text: 'rolled 1d20 and got 17 (Perception check)', timestamp: '18:15:32' },
            { id: 19, type: 'roll', channel: 'system', speaker: 'Ethan Cross', text: 'rolled 1d20 and got 8 (Investigation)', timestamp: '18:16:45' },
            { id: 20, type: 'leave', channel: 'system', speaker: 'PlayerThree', text: 'has disconnected from the server.', timestamp: '18:20:12' },
            { id: 21, type: 'dialogue', channel: 'staff', speaker: 'Admin_Mike', text: 'Keep an eye on the warehouse area, planning something big there.' },
            { id: 22, type: 'dialogue', channel: 'staff', speaker: 'Mod_Sarah', text: 'Got it, should I spawn the NPCs now or wait?' },
            { id: 23, type: 'dialogue', channel: 'staff', speaker: 'Admin_Mike', text: 'Wait until they get closer, we want the timing to be perfect.' },
            { id: 24, type: 'dialogue', channel: 'staff', speaker: 'Mod_James', text: 'Standing by. Ready to trigger the event when you give the signal.' }
        ];

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                t.classList.remove('active');
            });
            
            const activeTab = Array.from(tabs).find(t => t.getAttribute('data-tab') === tab);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Update placeholder text based on tab
            const input = document.getElementById('message-input');
            const placeholders = {
                'ic': 'Write in character...',
                'ooc': 'Out-of-character message...',
                'staff': 'Staff communication...'
            };
            input.placeholder = placeholders[tab] || 'Type your message here...';
            
            // Show/hide input based on tab
            const inputContainer = document.getElementById('input-container');
            const readOnly = document.getElementById('read-only');
            
            if (tab === 'log' || tab === 'system') {
                inputContainer.classList.add('hidden');
                readOnly.classList.remove('hidden');
            } else {
                inputContainer.classList.remove('hidden');
                readOnly.classList.add('hidden');
            }
            
            renderMessages();
        }

        function renderMessages(forceScroll = false) {
            const messagesContainer = document.getElementById('messages');
            const filteredMessages = messages.filter(msg => msg.channel === currentTab);
            
            // Check if user is near bottom before rendering (within 50px of bottom)
            const wasNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50;
            
            messagesContainer.innerHTML = '';
            
            filteredMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                if (currentTab === 'log') {
                    messageDiv.innerHTML = `<span class="timestamp">[${msg.timestamp}]</span>` +
                        (msg.type === 'action' 
                            ? `<span class="action">${msg.text}</span>`
                            : `<span class="speaker">${msg.speaker}:</span> <span class="log-message"><i>${msg.text}</i></span>`);
                } else if (currentTab === 'system') {
                    let content = `<span class="timestamp">[${msg.timestamp}]</span>`;
                    if (msg.type === 'join') {
                        content += `<span class="join">${msg.speaker}</span> <span class="system-text">${msg.text}</span>`;
                    } else if (msg.type === 'leave') {
                        content += `<span class="leave">${msg.speaker}</span> <span class="system-text">${msg.text}</span>`;
                    } else if (msg.type === 'roll') {
                        content += `<span class="roll">${msg.speaker}</span> <span class="system-text">${msg.text}</span>`;
                    } else if (msg.type === 'system') {
                        content += `<span class="system-text">${msg.text}</span>`;
                    }
                    messageDiv.innerHTML = content;
                } else if (currentTab === 'ic' || currentTab === 'ooc' || currentTab === 'staff') {
                    // IC/OOC/Staff - hide timestamps by default, show on hover
                    const timestamp = msg.timestamp ? `<span class="timestamp-ic">[${msg.timestamp}]</span> ` : '';
                    if (msg.type === 'action') {
                        messageDiv.innerHTML = `${timestamp}<span class="action">${msg.text}</span>`;
                    } else {
                        messageDiv.innerHTML = `${timestamp}<span class="speaker">${msg.speaker}:</span> <span class="text">${msg.text}</span>`;
                    }
                } else {
                    if (msg.type === 'action') {
                        messageDiv.innerHTML = `<span class="action">${msg.text}</span>`;
                    } else {
                        messageDiv.innerHTML = `<span class="speaker">${msg.speaker}:</span> <span class="text">${msg.text}</span>`;
                    }
                }
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Only auto-scroll if user was near bottom or if forced (like sending a message)
            if (wasNearBottom || forceScroll) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function updateCharCounter() {
            const input = document.getElementById('message-input');
            const counter = document.getElementById('char-counter');
            counter.textContent = `${input.value.length} / ${maxLength}`;
            
            // Gentle awareness: amber when approaching limit (400+)
            if (input.value.length >= 400) {
                counter.classList.add('approaching-limit');
            } else {
                counter.classList.remove('approaching-limit');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        } else if (event.key === 'Escape') {
            if (typeof gmod !== 'undefined' && gmod.onEscape) {
                gmod.onEscape();
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (text) {
                // In Gmod, you would call a Lua function here
                // Example: gmod.sendMessage(currentTab, text);
                console.log(`[${currentTab}] ${text}`);
                
                // For demo purposes, add to messages array
                const newMessage = {
                    id: messages.length + 1,
                    type: 'dialogue',
                    channel: currentTab,
                    speaker: 'You',
                    text: text
                };
                messages.push(newMessage);
                
                input.value = '';
                updateCharCounter();
                renderMessages(true);
            }
        }

        // Initialize
        renderMessages();

        // Gmod Integration Functions
        // These functions can be called from Lua to interact with the chat
        function addMessage(channel, type, speaker, text, timestamp) {
            messages.push({
                id: messages.length + 1,
                type: type,
                channel: channel,
                speaker: speaker,
                text: text,
                timestamp: timestamp
            });
            
            if (channel === currentTab) {
                renderMessages();
            }
        }

        function clearMessages() {
            messages.length = 0;
            renderMessages();
        }

        // Expose functions to Gmod
        window.gmodChat = {
            addMessage: addMessage,
            clearMessages: clearMessages,
            switchTab: switchTab,
            setStaffVisibility: setStaffVisibility
        };

        // Function to show/hide staff tab (call from Lua based on player permissions)
        function setStaffVisibility(isStaff) {
            const staffTab = document.querySelector('.tab[data-tab="staff"]');
            if (staffTab) {
                if (isStaff) {
                    staffTab.classList.remove('hidden');
                } else {
                    staffTab.classList.add('hidden');
                    // If they're on staff tab and lose permissions, kick them to IC
                    if (currentTab === 'staff') {
                        switchTab('ic');
                    }
                }
            }
        }
    </script>
</body>
</html>
